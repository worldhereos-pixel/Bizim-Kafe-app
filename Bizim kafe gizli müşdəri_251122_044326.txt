<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bizim Kafe â˜•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <!-- Tone.js SÉ™s effektlÉ™ri Ã¼Ã§Ã¼n -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <!-- Font Awesome ikonlarÄ± Ã¼Ã§Ã¼n -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Ã–zÉ™l ÅŸrift vÉ™ fon stillÉ™ri */
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600&display=swap');
        body { font-family: 'Fredoka', sans-serif; background-color: #f5efe6; }
        
        /* Æsas fon ÅŸÉ™kli */
        .chat-bg {
            background-color: #fdfbf7;
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23d6c099' fill-opacity='0.2' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
        }

        /* Mesaj baloncuklarÄ± */
        .my-message {
            background-color: #f7e6c4; /* TÃ¼nd QÉ™hvÉ™yi/Bej */
            border-radius: 1rem 1rem 0.2rem 1rem;
        }
        .other-message {
            background-color: #a76657; /* AÃ§Ä±q QÉ™hvÉ™yi */
            color: #fff;
            border-radius: 1rem 1rem 1rem 0.2rem;
        }
        .system-message {
            color: #d97706; /* KÉ™hrÉ™ba RÉ™ngi */
            font-style: italic;
        }

        /* Reaksiya AnimasiyalarÄ± */
        .reaction-effect {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            opacity: 0;
            animation: float-up 1.5s ease-out forwards;
            pointer-events: none;
            z-index: 1000;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        @keyframes float-up {
            0% { transform: translate(-50%, 0%); opacity: 1; }
            100% { transform: translate(-50%, -150%); opacity: 0; }
        }

        /* FÄ±rlatma AnimasiyasÄ± (StÉ™kan) */
        .flip-animate {
            animation: flip-rotate 1.5s ease-out forwards;
        }
        @keyframes flip-rotate {
            0% { transform: rotate(0deg) scale(1); opacity: 1; }
            50% { transform: rotate(180deg) scale(1.5); opacity: 1; }
            100% { transform: rotate(360deg) scale(0.5); opacity: 0; }
        }

        /* Oyun SeÃ§imi Dropdown AnimasiyasÄ± */
        .game-selector-enter { transform: scaleY(0); opacity: 0; }
        .game-selector-enter-active { transform: scaleY(1); opacity: 1; transition: transform 200ms ease-out, opacity 200ms ease-out; }
        .game-selector-exit { transform: scaleY(1); opacity: 1; }
        .game-selector-exit-active { transform: scaleY(0); opacity: 0; transition: transform 200ms ease-in, opacity 200ms ease-in; }

        /* Reaksiya Menyu */
        .reaction-menu {
            position: absolute;
            bottom: 100%; /* MesajÄ±n yuxarÄ±sÄ±nda */
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
        }
    </style>
</head>
<body class="bg-f5efe6 min-h-screen p-2 sm:p-4 flex items-center justify-center">

    <!-- Æsas TÉ™tbiq Konteyneri -->
    <div id="main-app" class="w-full max-w-lg lg:max-w-xl h-[95vh] flex flex-col rounded-xl shadow-2xl overflow-hidden bg-white">
        
        <!-- GiriÅŸ Paneli -->
        <div id="join-panel" class="p-8 flex flex-col space-y-4 justify-center items-center h-full">
            <h1 class="text-3xl font-bold text-red-800 mb-6 flex items-center">
                <i class="fas fa-coffee mr-3"></i> Bizim Kafe
            </h1>
            <p class="text-gray-600 text-center">Anonim qrup sÃ¶hbÉ™tinÉ™ vÉ™ oyunlara qoÅŸulun.</p>

            <input type="text" id="username-input" placeholder="AdÄ±nÄ±zÄ± daxil edin (MÉ™sÉ™lÉ™n: Æli)"
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 transition duration-150">

            <div class="w-full flex space-x-2">
                <input type="text" id="group-id-input" placeholder="Qrup ID-si (BoÅŸ buraxÄ±n vÉ™ ya daxil edin)"
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 transition duration-150">
                <button onclick="joinGroup()"
                        class="bg-red-800 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-200 flex items-center whitespace-nowrap">
                    <i class="fas fa-sign-in-alt mr-2"></i> QoÅŸul
                </button>
            </div>
            <div id="loading-spinner" class="hidden text-red-800 mt-4">
                <i class="fas fa-spinner fa-spin text-2xl"></i>
                <span class="ml-2">QoÅŸulur...</span>
            </div>
        </div>

        <!-- Æsas Ã‡at Paneli -->
        <div id="chat-panel" class="flex flex-col flex-grow hidden">
            
            <!-- BaÅŸlÄ±q / Kontrol Paneli -->
            <header id="chat-header" class="p-3 bg-red-800 text-white flex justify-between items-center shadow-md z-10">
                
                <!-- Sol: Qrup MÉ™lumatÄ± -->
                <div class="flex flex-col">
                    <div class="font-bold text-lg">Bizim Kafe â˜•</div>
                    <div class="text-xs opacity-80" id="my-id-display-container">
                        ID: <span id="my-id-display" class="font-mono cursor-pointer" onclick="copyId()">YÃ¼klÉ™nir...</span> 
                        <span id="copy-msg" class="ml-2 text-green-300 text-sm opacity-0 absolute bg-red-900 p-1 rounded-md">KopyalandÄ±!</span>
                    </div>
                </div>

                <!-- SaÄŸ: Oyun vÉ™ AyrÄ±lma DÃ¼ymÉ™lÉ™ri -->
                <div class="flex space-x-2 relative">
                    <!-- Oyunlar Button (Dropdown Trigger) -->
                    <button onclick="toggleGameSelector()" class="bg-red-700 hover:bg-red-600 text-white font-medium py-2 px-3 rounded-lg transition duration-200 shadow-lg text-sm flex items-center">
                        <i class="fas fa-gamepad mr-2"></i> Oyunlar
                    </button>
                    <!-- Qrupdan AyrÄ±l DÃ¼ymÉ™si -->
                    <button onclick="leaveGroup()" class="bg-red-700 hover:bg-red-600 text-white font-medium py-2 px-3 rounded-lg shadow-lg text-sm flex items-center">
                        <i class="fas fa-sign-out-alt"></i> AyrÄ±l
                    </button>
                    
                    <!-- Oyun SeÃ§imi Dropdown Paneli (ÆvvÉ™lcÉ™ Gizli) -->
                    <div id="game-selector" 
                         class="absolute right-0 top-full mt-2 w-48 bg-white text-gray-800 rounded-xl shadow-2xl border border-gray-200 
                                transform origin-top hidden game-selector-enter" 
                         role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
                        
                        <h3 class="p-3 text-sm font-bold border-b bg-gray-50 rounded-t-xl text-red-800">Oyun SeÃ§in</h3>
                        
                        <!-- MÃ¶vcud Oyunlar -->
                        <button onclick="selectGame('hangman')" role="menuitem"
                                class="w-full text-left p-3 hover:bg-red-100 transition duration-150 flex items-center text-red-800 border-b">
                            <i class="fas fa-gavel mr-2"></i> KÉ™llÉ™-KÉ™llÉ™yÉ™
                        </button>
                        <button onclick="selectGame('secret_customer')" role="menuitem"
                                class="w-full text-left p-3 hover:bg-red-100 transition duration-150 flex items-center text-red-800 border-b">
                            <i class="fas fa-user-secret mr-2"></i> Gizli MÃ¼ÅŸtÉ™ri
                        </button>
                        <button onclick="selectGame('quiz')" role="menuitem"
                                class="w-full text-left p-3 hover:bg-red-100 transition duration-150 flex items-center text-red-800">
                            <i class="fas fa-question-circle mr-2"></i> Quiz (TezliklÉ™)
                        </button>
                    </div>
                </div>
            </header>

            <!-- Ã‡at MesajlarÄ± SahÉ™si -->
            <div id="messages-container" class="flex flex-col flex-grow overflow-hidden">
                <!-- Oyun Statusu buraya daxil olur -->
                <div id="game-status-display" class="p-3 bg-yellow-50 border border-yellow-300 rounded-lg m-3 shadow-inner hidden"></div>
                <div id="messages" class="chat-bg flex-grow overflow-y-auto p-4 space-y-4">
                    <!-- Mesajlar bura daxil olacaq -->
                </div>
            </div>

            <!-- Mesaj GiriÅŸ Paneli -->
            <div class="p-3 bg-white border-t border-gray-200 flex items-center">
                <input type="text" id="message-input" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..."
                       class="flex-grow p-3 border border-gray-300 rounded-l-lg focus:ring-red-500 focus:border-red-500 transition duration-150"
                       onkeypress="handleKeyPress(event)">
                <button onclick="sendMessage()"
                        class="bg-red-800 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-r-lg shadow-md transition duration-200">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>

    </div>

    <!-- Reaksiya EfektlÉ™ri Ã¼Ã§Ã¼n Konteyner -->
    <div id="reaction-container"></div>

    <script type="module">
        // Firebase KonfiqurasiyasÄ± (Canvas TÉ™rÉ™findÉ™n TÉ™min Edilir)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase vÉ™ Firestore ImportlarÄ±
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, updateDoc, arrayUnion, arrayRemove, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Tone.js
        const synth = new Tone.PolySynth(Tone.Synth).toDestination();

        // TÉ™tbiqi BaÅŸlat
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Global State (Qlobal VÉ™ziyyÉ™t)
        let myPeerId = null;
        let peer = null;
        let connections = {};
        let currentUserId = null;
        let userName = 'Anonim';
        let isGroupLeader = false;
        let gameData = { game: null, state: null, myRole: null }; // myRole É™lavÉ™ edildi
        let peerCount = 0; // QrupdakÄ± istifadÉ™Ã§i sayÄ±
        let activeGroupId = null; // HazÄ±rda qoÅŸulmuÅŸ qrupun ID-si
        let chatMessages = {}; // {messageId: {reactions: {tea: 2, flip: 1}, senderId: '...'}, ...}

        // --- Auth vÉ™ Firebase BaÅŸlanÄŸÄ±cÄ± ---

        // Ä°stifadÉ™Ã§i Auth MÉ™lumatÄ±nÄ± Yoxla vÉ™ Firestore-u BaÅŸlat
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                console.log("Firebase Auth HazÄ±rdÄ±r. User ID:", currentUserId);
            } else {
                console.error("Firebase Auth xÉ™tasÄ±: Ä°stifadÉ™Ã§i tapÄ±lmadÄ±.");
            }
        });

        // XÃ¼susi token ilÉ™ daxil olmaq (Canvas Ã¼Ã§Ã¼n mÉ™cburidir)
        async function signIn() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase daxil olma xÉ™tasÄ±:", error);
            }
        }
        signIn();

        // Firestore MÉ™lumat Yolu
        function getGroupDocRef(groupId) {
            return doc(db, 'artifacts', appId, 'public', 'data', 'groups', groupId);
        }
        function getMessagesColRef(groupId) {
            return collection(db, 'artifacts', appId, 'public', 'data', 'groups', groupId, 'messages');
        }

        // --- PeerJS vÉ™ QoÅŸulma MÉ™ntiqi ---

        function initializePeer(peerId) {
            peer = new Peer(peerId);

            peer.on('open', (id) => {
                myPeerId = id;
                document.getElementById('my-id-display').innerText = id;
                console.log('Peer ID-niz:', id);

                if (activeGroupId === id) {
                    showChatPanel();
                    listenToGroupChanges(id);
                    listenToChatMessages(id);
                } else if (activeGroupId) {
                    connectToPeer(activeGroupId);
                    showChatPanel();
                    // Liderin cavabÄ±nÄ± gÃ¶zlÉ™yÉ™rÉ™k qrup statusunu dinlÉ™
                    listenToGroupChanges(activeGroupId);
                    listenToChatMessages(activeGroupId);
                }
                
                document.getElementById('loading-spinner').classList.add('hidden');
            });

            peer.on('connection', (conn) => {
                conn.on('open', () => handleNewConnection(conn, false));
            });

            peer.on('error', (err) => {
                console.error("PeerJS XÉ™tasÄ±:", err);
                alertModal("XÉ™ta", `PeerJS XÉ™tasÄ±: ${err.type}. YenidÉ™n cÉ™hd edin.`, true);
                document.getElementById('loading-spinner').classList.add('hidden');
            });
        }

        function connectToPeer(targetId) {
            if (targetId === myPeerId) return;

            const conn = peer.connect(targetId);
            conn.on('open', () => {
                handleNewConnection(conn, true);
                conn.send({ type: 'join', name: userName, userId: currentUserId, isLeader: isGroupLeader });
            });
        }

        function handleNewConnection(conn, isOutgoing) {
            if (connections[conn.peer]) return;

            connections[conn.peer] = conn;
            peerCount = Object.keys(connections).length + 1;

            conn.on('data', (data) => handleData(data, conn.peer));
            conn.on('close', () => handleDisconnect(conn.peer));
            conn.on('error', (err) => console.error(`ÆlaqÉ™ XÉ™tasÄ± ${conn.peer}:`, err));

            if (!isOutgoing && isGroupLeader) {
                // Lider gÉ™lÉ™n qoÅŸulmaya Ã¶z mÉ™lumatÄ±nÄ± gÃ¶ndÉ™rir
                conn.send({ type: 'welcome', name: userName, leaderId: myPeerId, userId: currentUserId });
                broadcast({ type: 'peer_join', name: 'Yeni Ãœzv', peerId: conn.peer }, conn.peer);
            }
        }
        
        function handleDisconnect(peerId) {
            delete connections[peerId];
            peerCount = Object.keys(connections).length + 1;
            addSystemMessage(`Ä°stifadÉ™Ã§i ${peerId.substring(0, 4)}... qrupdan ayrÄ±ldÄ±.`, true);
        }

        function broadcast(data, excludePeerId = null) {
            Object.values(connections).forEach(conn => {
                if (conn.peer !== excludePeerId) {
                    conn.send(data);
                }
            });
        }
        
        // --- Æsas MÉ™ntiq FunksiyalarÄ± ---

        window.joinGroup = async function() {
            const usernameInput = document.getElementById('username-input');
            const groupIdInput = document.getElementById('group-id-input');
            const loadingSpinner = document.getElementById('loading-spinner');

            if (!usernameInput.value.trim()) {
                alertModal("XÉ™bÉ™rdarlÄ±q", "ZÉ™hmÉ™t olmasa, adÄ±nÄ±zÄ± daxil edin.");
                return;
            }
            
            userName = escapeHtml(usernameInput.value.trim());
            const requestedGroupId = groupIdInput.value.trim();
            loadingSpinner.classList.remove('hidden');

            try {
                if (!currentUserId) {
                    await new Promise(resolve => onAuthStateChanged(auth, resolve));
                }

                activeGroupId = requestedGroupId || currentUserId;
                isGroupLeader = !requestedGroupId;

                if (isGroupLeader) {
                    await setDoc(getGroupDocRef(activeGroupId), {
                        leaderId: currentUserId,
                        leaderPeerId: activeGroupId,
                        game: null,
                        gameState: null,
                        createdAt: new Date().getTime(),
                    }, { merge: true });
                    addSystemMessage(`Yeni qrup yaratdÄ±nÄ±z. Qrup ID-si: ${activeGroupId}`, true);
                } else {
                    addSystemMessage(`Qrupa qoÅŸulur: ${activeGroupId}`, true);
                }
                
                initializePeer(currentUserId); // currentUserId Peer ID kimi istifadÉ™ edilir
            } catch (e) {
                console.error("Qrupa qoÅŸulma/yaratma xÉ™tasÄ±:", e);
                alertModal("XÉ™ta", "Qrupa qoÅŸulmaq mÃ¼mkÃ¼n olmadÄ±. Konsolu yoxlayÄ±n.");
                loadingSpinner.classList.add('hidden');
            }
        };

        // Qrup DÉ™yiÅŸikliklÉ™rini DinlÉ™mÉ™k (Oyun Statusu)
        function listenToGroupChanges(groupId) {
            const groupRef = getGroupDocRef(groupId);
            onSnapshot(groupRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    const oldGame = gameData.game;
                    const oldState = gameData.state;

                    gameData.game = data.game;
                    gameData.state = data.gameState;
                    
                    // Oyun rollarÄ±nÄ± yenilÉ™ (Gizli MÃ¼ÅŸtÉ™ri Ã¼Ã§Ã¼n)
                    if (gameData.game === 'secret_customer' && gameData.state && gameData.state.players) {
                        const myPlayer = gameData.state.players.find(p => p.peerId === myPeerId);
                        gameData.myRole = myPlayer ? myPlayer.role : 'GÃ¶zlÉ™yÉ™n';
                    } else if (!gameData.game) {
                        gameData.myRole = null;
                    }

                    // Oyun bitdikdÉ™ sistem mesajÄ±
                    if (oldGame && !gameData.game && oldState) {
                         addSystemMessage(`Oyun bitdi. NÉ™ticÉ™ni yoxlayÄ±n.`, true);
                    }
                    
                    renderGameStatus();
                }
            }, (error) => {
                console.error("Firestore dinlÉ™mÉ™ xÉ™tasÄ±:", error);
            });
        }
        
        // MesajlarÄ± DinlÉ™mÉ™k (Reaksiyalar daxil)
        function listenToChatMessages(groupId) {
            const messagesRef = getMessagesColRef(groupId);
            const q = query(messagesRef);
            
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const msg = change.doc.data();
                    const msgId = change.doc.id;
                    
                    if (change.type === "added") {
                        // Yeni mesaj: ReaksiyasÄ±z É™lavÉ™ et
                        addMessageToUI(msg, msg.senderId === myPeerId, msgId);
                        chatMessages[msgId] = msg;
                    }
                    
                    if (change.type === "modified") {
                        // Reaksiya dÉ™yiÅŸikliyi: UI-Ä± yenilÉ™
                        chatMessages[msgId] = msg;
                        updateMessageReactions(msgId, msg.reactions || {});
                    }
                });
            }, (error) => {
                console.error("Mesaj dinlÉ™mÉ™ xÉ™tasÄ±:", error);
            });
        }

        // --- Ã‡at, Mesaj vÉ™ Reaksiya MÉ™ntiqi ---

        window.sendMessage = function() {
            const input = document.getElementById('message-input');
            const messageText = input.value.trim();

            if (messageText === '') return;
            
            // Oyunun gediÅŸatÄ±nÄ± yoxla
            if (gameData.game) {
                handleGameAction(messageText);
                input.value = '';
                return;
            } 
            
            // Normal Ã§at mesajÄ±
            const message = {
                senderId: myPeerId,
                senderName: userName,
                text: escapeHtml(messageText),
                timestamp: new Date().toLocaleTimeString('az-AZ', { hour: '2-digit', minute: '2-digit' }),
                reactions: {}, // {reactionType: count}
                type: 'chat'
            };

            // Firestore-a yaz
            addDoc(getMessagesColRef(activeGroupId), message).then(docRef => {
                console.log("Mesaj yazÄ±ldÄ±:", docRef.id);
            }).catch(e => console.error("Mesaj yazÄ±lma xÉ™tasÄ±:", e));

            input.value = '';
        };

        // GÉ™lÉ™n PeerJS datasÄ±nÄ± idarÉ™ et
        function handleData(data, peerId) {
            switch (data.type) {
                case 'join':
                    addSystemMessage(`${data.name} qrupa qoÅŸuldu.`, true);
                    break;
                case 'peer_join':
                    addSystemMessage(`Yeni istifadÉ™Ã§i: ${peerId.substring(0, 4)}...`, true);
                    break;
                case 'welcome':
                    addSystemMessage(`Lider ${data.leaderId.substring(0, 4)}... tÉ™rÉ™findÉ™n xoÅŸ gÉ™ldiniz.`, true);
                    break;
                case 'reaction':
                    // Reaksiya PeerJS ilÉ™ gÃ¶ndÉ™rilmir, Firestore ilÉ™ iÅŸlÉ™yir.
                    // Ancaq É™gÉ™r reaksiya gÃ¶ndÉ™rilirsÉ™, onu gÃ¶stÉ™r:
                    showReactionEffect(data.reactionType, data.senderName);
                    break;
                case 'game_msg':
                    addSystemMessage(data.text, data.html);
                    break;
                default:
                    console.warn("NamÉ™lum data tipi:", data.type);
            }
        }
        
        // MesajÄ± Ã§at sahÉ™sinÉ™ É™lavÉ™ et
        function addMessageToUI(message, isMine, messageId) {
            const messagesDiv = document.getElementById('messages');
            let messageDiv = document.getElementById('msg-' + messageId);

            if (messageDiv) return; // Mesaj artÄ±q É™lavÉ™ edilibsÉ™ geri qayÄ±t

            messageDiv = document.createElement('div');
            messageDiv.id = 'msg-' + messageId;
            
            let messageClass = isMine ? 'self-end my-message' : 'self-start other-message';
            let sender = isMine ? 'Siz' : message.senderName;
            
            messageDiv.className = `max-w-[80%] p-3 shadow-md ${messageClass} relative`;
            messageDiv.innerHTML = `
                <div class="text-xs font-semibold ${isMine ? 'text-gray-700' : 'text-gray-300'} mb-1">${sender}</div>
                <p class="${isMine ? 'text-gray-800' : 'text-white'}">${message.text}</p>
                <div class="text-[0.6rem] mt-1 text-right ${isMine ? 'text-gray-500' : 'text-gray-200'}">${message.timestamp}</div>
                
                <!-- Reaksiya Buttonu -->
                <button onclick="toggleReactionMenu('${messageId}', event)" 
                        class="absolute ${isMine ? 'left-0 transform -translate-x-full pr-1' : 'right-0 transform translate-x-full pl-1'} 
                               top-1/2 -translate-y-1/2 text-lg hover:scale-110 transition-transform text-red-400">
                    <i class="fas fa-plus-circle"></i>
                </button>

                <!-- Reaksiya GÃ¶stÉ™ricisi -->
                <div id="reactions-${messageId}" 
                     class="absolute -bottom-2 ${isMine ? 'left-0 ml-1' : 'right-0 mr-1'} bg-white text-xs p-1 rounded-full shadow-md flex space-x-1 opacity-90">
                </div>
            `;

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            updateMessageReactions(messageId, message.reactions || {});
        }
        
        // MesajÄ±n reaksiyalarÄ±nÄ± yenilÉ™
        function updateMessageReactions(messageId, reactions) {
            const reactionDiv = document.getElementById(`reactions-${messageId}`);
            if (!reactionDiv) return;

            reactionDiv.innerHTML = '';
            let totalReactions = 0;

            if (reactions.tea && reactions.tea > 0) {
                reactionDiv.innerHTML += `<span class="px-1 bg-yellow-100 rounded-full">â˜• ${reactions.tea}</span>`;
                totalReactions += reactions.tea;
            }
            if (reactions.flip && reactions.flip > 0) {
                reactionDiv.innerHTML += `<span class="px-1 bg-red-100 rounded-full">ğŸ—‘ï¸ ${reactions.flip}</span>`;
                totalReactions += reactions.flip;
            }

            if (totalReactions > 0) {
                reactionDiv.classList.remove('hidden');
            } else {
                reactionDiv.classList.add('hidden');
            }
        }

        // Reaksiya Menyu
        window.toggleReactionMenu = function(messageId, event) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.getElementById('msg-' + messageId);
            
            // ÆgÉ™r Ã¶z mesajÄ±mdÄ±rsa reaksiya qoymuram
            if (messageDiv.classList.contains('my-message')) {
                alertModal("MÉ™lumat", "Ã–z mesajÄ±nÄ±za reaksiya gÃ¶ndÉ™rÉ™ bilmÉ™zsiniz.");
                return;
            }

            const menuId = `menu-${messageId}`;
            let menu = document.getElementById(menuId);
            
            // ÆvvÉ™lki menularÄ± baÄŸla
            document.querySelectorAll('.reaction-menu').forEach(m => {
                if (m.id !== menuId) m.remove();
            });

            if (menu) {
                menu.remove();
                return;
            }

            // Yeni menyu yarat
            const menuHtml = `
                <div id="${menuId}" class="reaction-menu bg-white rounded-full shadow-xl flex p-1 space-x-1 border border-gray-200">
                    <button onclick="sendReaction('${messageId}', 'tea', '${messageDiv.querySelector('.text-xs').textContent}')" class="p-2 text-2xl hover:bg-yellow-100 rounded-full transition-colors" title="Ã‡ay SÃ¼z (BÉ™yÉ™nmÉ™)">â˜•</button>
                    <button onclick="sendReaction('${messageId}', 'flip', '${messageDiv.querySelector('.text-xs').textContent}')" class="p-2 text-2xl hover:bg-red-100 rounded-full transition-colors" title="StÉ™kan FÄ±rlat (BÉ™yÉ™nmÉ™mÉ™)">ğŸ—‘ï¸</button>
                </div>
            `;
            messageDiv.insertAdjacentHTML('beforeend', menuHtml);
        }

        // Reaksiya GÃ¶ndÉ™rmÉ™k (Firestore Transaction)
        window.sendReaction = async function(messageId, reactionType, senderName) {
            document.getElementById(`menu-${messageId}`)?.remove();

            const messageRef = doc(getMessagesColRef(activeGroupId), messageId);
            try {
                await runTransaction(db, async (transaction) => {
                    const doc = await transaction.get(messageRef);
                    if (!doc.exists()) {
                        throw "Mesaj tapÄ±lmadÄ±!";
                    }

                    const newReactions = doc.data().reactions || {};
                    newReactions[reactionType] = (newReactions[reactionType] || 0) + 1;

                    transaction.update(messageRef, { reactions: newReactions });
                });

                // ReaksiyanÄ± bÃ¼tÃ¼n PeerlÉ™rÉ™ gÃ¶stÉ™r (vizual effekt Ã¼Ã§Ã¼n)
                broadcast({ type: 'reaction', reactionType: reactionType, senderName: userName });
                showReactionEffect(reactionType, userName);

            } catch (e) {
                console.error("Reaksiya gÃ¶ndÉ™rmÉ™ xÉ™tasÄ±:", e);
                alertModal("XÉ™ta", "Reaksiya gÃ¶ndÉ™rilmÉ™di.");
            }
        }
        
        // Reaksiya Vizual vÉ™ SÉ™s Effektini GÃ¶stÉ™r
        function showReactionEffect(reactionType, senderName) {
            const container = document.getElementById('reaction-container');
            const effect = document.createElement('div');
            
            let emoji = reactionType === 'tea' ? 'â˜•' : 'ğŸ—‘ï¸';
            let soundNote = reactionType === 'tea' ? 'C5' : 'F4';
            let soundDuration = reactionType === 'tea' ? '8n' : '16n';
            let soundType = reactionType === 'tea' ? 'sine' : 'square';

            effect.className = `reaction-effect ${reactionType === 'flip' ? 'flip-animate' : ''}`;
            effect.textContent = emoji;
            
            container.appendChild(effect);

            // SÉ™s Effektini Oynat
            Tone.start().then(() => {
                synth.triggerAttackRelease(soundNote, soundDuration, undefined, 0.5, soundType);
            });

            // Elementi sil
            setTimeout(() => {
                effect.remove();
            }, 1500);
        }
        
        // Sistem mesajÄ±nÄ± É™lavÉ™ et
        function addSystemMessage(text, isHtml = false) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'text-center text-xs system-message p-2';
            
            if (isHtml) {
                messageDiv.innerHTML = text;
            } else {
                messageDiv.textContent = text;
            }

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // --- Oyun MÉ™ntiqi: KÉ™llÉ™-KÉ™llÉ™yÉ™ (Hangman) vÉ™ Gizli MÃ¼ÅŸtÉ™ri ---

        const hangmanWords = ['proqramlaÅŸdÄ±rma', 'kodlaÅŸdÄ±rma', 'alqoritm', 'ÅŸÉ™bÉ™kÉ™', 'server', 'kompÃ¼ter'];
        const MAX_MISSES = 6;
        const SECRET_CUSTOMER_ROLES = ['Kassir', 'Barista', 'ServisÃ§i', 'TÉ™mizlikÃ§i'];
        const SECRET_CUSTOMER_ORDERS = [
            'Bir latte istÉ™yirÉ™m.', 
            'Masa 2-dÉ™ Ã§ay istÉ™yirlÉ™r.', 
            'SÃ¼frÉ™lÉ™rdÉ™n biri Ã§irkli qalÄ±b, tÉ™mizlÉ™yin.', 
            'QapÄ±dan yeni mÃ¼ÅŸtÉ™ri gÉ™ldi, buyurun.',
            'Hesab istÉ™yirlÉ™r.'
        ];

        // Oyunun HazÄ±rlanmasÄ± (Gizli MÃ¼ÅŸtÉ™ri)
        function initializeSecretCustomer() {
            const allPlayers = Object.keys(connections).concat(myPeerId).map(id => ({ peerId: id, name: connections[id]?.peerName || (id === myPeerId ? userName : 'Anonim'), role: null, votes: 0 }));

            if (allPlayers.length < 4) {
                 alertModal("XÉ™bÉ™rdarlÄ±q", `Gizli MÃ¼ÅŸtÉ™ri oyunu Ã¼Ã§Ã¼n É™n az 4 oyunÃ§u lazÄ±mdÄ±r. HazÄ±rda: ${allPlayers.length}`);
                 return null;
            }

            // RollarÄ± payla
            const customerIndex = Math.floor(Math.random() * allPlayers.length);
            allPlayers[customerIndex].role = 'Gizli MÃ¼ÅŸtÉ™ri';

            let staffRoles = [...SECRET_CUSTOMER_ROLES];
            let staffCount = 0;
            for (let i = 0; i < allPlayers.length; i++) {
                if (i !== customerIndex) {
                    allPlayers[i].role = staffRoles[staffCount % staffRoles.length];
                    staffCount++;
                }
            }

            return {
                status: 'roles_assigned', // rolls_assigned, orders, discussion, voting, finished
                players: allPlayers,
                secretCustomer: allPlayers[customerIndex].peerId,
                rounds: 1,
                currentOrder: null,
                responses: {}, // {peerId: responseText}
                votes: {}, // {voterId: votedId}
                votingTarget: null, // SÉ™svermÉ™dÉ™ hÉ™dÉ™f
                maxRounds: 3 // Maksimum 3 raund
            };
        }

        // Oyunun Statusunu YenilÉ™ (YalnÄ±z Lider)
        async function updateGroupGameStatus(game, newState) {
            if (!isGroupLeader || !activeGroupId) return;
            
            await updateDoc(getGroupDocRef(activeGroupId), {
                game: game,
                gameState: newState
            });
        }
        
        // Oyun HÉ™rÉ™kÉ™tlÉ™rini Ä°darÉ™ Et (Lider tÉ™rÉ™findÉ™n)
        function handleGameAction(messageText) {
            if (gameData.game === 'hangman') {
                handleHangmanGuess(messageText);
            } else if (gameData.game === 'secret_customer') {
                handleSecretCustomerAction(messageText);
            }
        }
        
        async function handleSecretCustomerAction(text) {
             const state = gameData.state;
             const normalizedText = escapeHtml(text).trim();

             if (state.status === 'orders') {
                // SifariÅŸlÉ™rÉ™ cavab vermÉ™ mÉ™rhÉ™lÉ™si
                if (state.responses[myPeerId]) {
                    addSystemMessage("Siz artÄ±q sifariÅŸÉ™ cavab vermisiniz.", false);
                    return;
                }
                
                // CavabÄ± qeyd et
                state.responses[myPeerId] = normalizedText;
                
                // HÉ™r kÉ™s cavab verdikdÉ™ (Ã–zÃ¼mÃ¼z + qoÅŸulmalar)
                if (Object.keys(state.responses).length === state.players.length) {
                    state.status = 'discussion';
                    
                    let allResponses = "Cavablar:\n";
                    state.players.forEach(p => {
                        allResponses += `**${p.name} (${p.role})**: ${state.responses[p.peerId] || 'Cavab yoxdur'}\n`;
                    });

                    const msg = `*** DÄ°QQÆT! *** BÃ¼tÃ¼n cavablar alÄ±ndÄ±. Ä°ndi kimin **Gizli MÃ¼ÅŸtÉ™ri** olduÄŸuna dair mÃ¼zakirÉ™ baÅŸlayÄ±r. Kim qÉ™ribÉ™ davrandÄ±?`;
                    addSystemMessage(msg, true);
                    broadcast({ type: 'game_msg', text: msg, html: true });
                }

                await updateGroupGameStatus('secret_customer', state);
                
             } else if (state.status === 'discussion') {
                 // MÃ¼zakirÉ™ mÉ™rhÉ™lÉ™si - yalnÄ±z Ã§at
                 const message = {
                    senderId: myPeerId,
                    senderName: userName,
                    text: normalizedText,
                    timestamp: new Date().toLocaleTimeString('az-AZ', { hour: '2-digit', minute: '2-digit' }),
                    reactions: {}, 
                    type: 'chat'
                 };
                 addDoc(getMessagesColRef(activeGroupId), message);
                 
             } else if (state.status === 'voting') {
                // SÉ™svermÉ™ mÉ™rhÉ™lÉ™si
                const votedPlayer = state.players.find(p => p.name.toLowerCase() === normalizedText.toLowerCase());

                if (!votedPlayer) {
                    addSystemMessage(`OyunÃ§u adÄ± sÉ™hvdir. ZÉ™hmÉ™t olmasa, tam vÉ™ dÃ¼zgÃ¼n adÄ± yazÄ±n: ${state.players.map(p => p.name).join(', ')}`, false);
                    return;
                }

                if (state.votes[myPeerId]) {
                    addSystemMessage("Siz artÄ±q sÉ™s vermisiniz.", false);
                    return;
                }
                
                state.votes[myPeerId] = votedPlayer.peerId;
                
                // HÉ™r kÉ™s sÉ™s verdikdÉ™
                if (Object.keys(state.votes).length === state.players.length) {
                    state.status = 'finished';
                    finalizeSecretCustomerGame(state);
                } else {
                    await updateGroupGameStatus('secret_customer', state);
                }
             }
        }
        
        // Oyun Statusunu UI-da GÃ¶stÉ™r
        function renderGameStatus() {
            const statusDiv = document.getElementById('game-status-display');
            
            if (gameData.game === 'hangman' && gameData.state) {
                // KÉ™llÉ™-KÉ™llÉ™yÉ™ statusu
                const state = gameData.state;
                const { display } = getHangmanDisplay(state);
                
                statusDiv.classList.remove('hidden');
                statusDiv.className = 'p-3 bg-yellow-50 border border-yellow-300 rounded-lg m-3 shadow-inner';
                statusDiv.innerHTML = `
                    <div class="text-sm font-semibold text-red-800">
                        <i class="fas fa-gavel mr-1"></i> KÆLLÆ-KÆLLÆYÆ OYUNU
                    </div>
                    <div class="mt-1 text-base text-gray-700">
                        SÃ¶z: <span class="font-mono text-xl tracking-widest">${display.split('').join(' ')}</span>
                    </div>
                    <div class="mt-1 text-sm text-gray-600">
                        Qalan CÉ™za: <span class="font-bold text-red-600">${state.missesLeft}</span>
                        | TÉ™xminlÉ™r: ${state.guessedLetters.sort().join(', ') || 'heÃ§ biri'}
                    </div>
                `;
            } else if (gameData.game === 'secret_customer' && gameData.state) {
                // Gizli MÃ¼ÅŸtÉ™ri statusu
                const state = gameData.state;
                let statusText = '';
                
                if (state.status === 'roles_assigned' || state.status === 'orders' || state.status === 'discussion' || state.status === 'voting') {
                    statusDiv.className = 'p-3 bg-red-100 border border-red-300 rounded-lg m-3 shadow-inner';
                    
                    let roleDisplay = gameData.myRole === 'Gizli MÃ¼ÅŸtÉ™ri' ? '<span class="text-red-700 font-bold">Gizli MÃ¼ÅŸtÉ™ri</span>' : `<span class="text-green-700 font-bold">${gameData.myRole}</span>`;
                    
                    statusText += `<div class="text-sm font-semibold text-red-800 flex justify-between items-center">
                        <i class="fas fa-user-secret mr-1"></i> GÄ°ZLÄ° MÃœÅTÆRÄ°
                        <span class="text-xs text-red-500">Raund: ${state.rounds}/${state.maxRounds}</span>
                    </div>
                    <div class="mt-2 text-base text-gray-800">
                        <span class="font-bold">Sizin Rolunuz:</span> ${roleDisplay}
                    </div>`;

                    if (state.status === 'orders') {
                        let respondedCount = Object.keys(state.responses).length;
                        statusText += `<div class="mt-1 text-sm text-gray-600">
                            <span class="font-bold">HazÄ±rkÄ± SifariÅŸ:</span> ${state.currentOrder}
                        </div>
                        <div class="mt-1 text-xs text-gray-500">
                            Cavab VerÉ™nlÉ™r: ${respondedCount}/${state.players.length} | CavabÄ±nÄ±zÄ± Ã§ata yazÄ±n.
                        </div>`;
                    } else if (state.status === 'discussion') {
                        statusText += `<div class="mt-1 text-sm text-red-700 font-bold">
                            MÃ¼zakirÉ™ MÉ™rhÉ™lÉ™si: Kim ÅŸÃ¼bhÉ™lidir? Ã‡atda mÃ¼zakirÉ™ edin.
                        </div>
                        <button onclick="startSecretCustomerVote()" class="mt-2 w-full bg-red-700 hover:bg-red-600 text-white text-sm font-bold py-1 rounded-lg">
                            SÉ™svermÉ™yÉ™ BaÅŸla (YalnÄ±z Lider)
                        </button>`;
                    } else if (state.status === 'voting') {
                        let votedCount = Object.keys(state.votes).length;
                         let myVoteStatus = state.votes[myPeerId] ? `âœ… SÉ™s verdiniz.` : `âŒ GÃ¶zlÉ™yir`;
                        statusText += `<div class="mt-1 text-sm text-red-700 font-bold">
                            SÉ™svermÉ™ MÉ™rhÉ™lÉ™si! <span class="font-normal text-gray-600">(AdÄ± Ã§ata yazÄ±n)</span>
                        </div>
                        <div class="mt-1 text-xs text-gray-500">
                             SÉ™s VerÉ™nlÉ™r: ${votedCount}/${state.players.length} | ${myVoteStatus}
                        </div>
                        <div class="mt-1 text-sm text-gray-600">
                            OyunÃ§ular: ${state.players.map(p => p.name).join(', ')}
                        </div>`;
                    }
                    
                } else if (state.status === 'finished') {
                    // Oyunun bitmÉ™ nÉ™ticÉ™si
                    statusDiv.className = 'p-3 bg-green-100 border border-green-300 rounded-lg m-3 shadow-inner';
                    statusText = `
                        <div class="text-lg font-bold text-green-700">OYUN BÄ°TDÄ°!</div>
                        <div class="text-sm mt-1">NÉ™ticÉ™ni Ã§ata yazÄ±lan sistem mesajÄ±ndan oxuyun.</div>
                        <button onclick="endSecretCustomerGame()" class="mt-2 w-full bg-green-700 hover:bg-green-600 text-white text-sm font-bold py-1 rounded-lg">
                            Oyunun NÉ™ticÉ™sini GÃ¶stÉ™r (YalnÄ±z Lider)
                        </button>
                    `;
                }

                statusDiv.innerHTML = statusText;
                statusDiv.classList.remove('hidden');

            } else {
                statusDiv.classList.add('hidden');
            }
            // HÉ™r yenilÉ™nmÉ™dÉ™ Ã§atÄ± É™n aÅŸaÄŸÄ±ya endir
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }

        // Gizli MÃ¼ÅŸtÉ™ri - NÃ¶vbÉ™ti AddÄ±m (YalnÄ±z Lider)
        function advanceSecretCustomerGame() {
            if (!isGroupLeader || gameData.game !== 'secret_customer') return;
            const state = gameData.state;

            if (state.status === 'roles_assigned' || state.status === 'discussion') {
                // SifariÅŸ mÉ™rhÉ™lÉ™sinÉ™ keÃ§
                const orderIndex = Math.floor(Math.random() * SECRET_CUSTOMER_ORDERS.length);
                state.currentOrder = SECRET_CUSTOMER_ORDERS[orderIndex];
                state.responses = {}; // CavablarÄ± sÄ±fÄ±rla
                state.status = 'orders';
                
                const msg = `*** YENÄ° SÄ°FARÄ°Å! (Raund ${state.rounds}) ***<br><span class="text-xl font-bold text-red-700">${state.currentOrder}</span><br>RollarÄ±nÄ±za uyÄŸun cavabÄ±nÄ±zÄ± Ã§ata yazÄ±n! Gizli MÃ¼ÅŸtÉ™ri Ã§aÅŸdÄ±rmaÄŸa Ã§alÄ±ÅŸÄ±r.`;
                addSystemMessage(msg, true);
                broadcast({ type: 'game_msg', text: msg, html: true });

            } else if (state.status === 'orders') {
                // SifariÅŸ mÉ™rhÉ™lÉ™si avtomatik olaraq cavablar bitdikdÉ™ 'discussion'a keÃ§ir (handleSecretCustomerAction daxilindÉ™)
                return;
            } else if (state.status === 'voting') {
                 // SÉ™svermÉ™ mÉ™rhÉ™lÉ™si avtomatik olaraq sÉ™s bitdikdÉ™ 'finished'É™ keÃ§ir
                 return;
            }
            
            updateGroupGameStatus('secret_customer', state);
        }
        
        // Gizli MÃ¼ÅŸtÉ™ri - SÉ™svermÉ™yÉ™ BaÅŸla (YalnÄ±z Lider)
        window.startSecretCustomerVote = function() {
            if (!isGroupLeader || gameData.game !== 'secret_customer' || gameData.state.status !== 'discussion') {
                 alertModal("XÉ™bÉ™rdarlÄ±q", "SÉ™svermÉ™yÉ™ baÅŸlamaq Ã¼Ã§Ã¼n qrup rÉ™hbÉ™ri olmalÄ± vÉ™ mÃ¼zakirÉ™ mÉ™rhÉ™lÉ™sindÉ™ olmalÄ±sÄ±nÄ±z.");
                 return;
            }
            
            const state = gameData.state;
            state.status = 'voting';
            state.votes = {}; // SÉ™slÉ™ri sÄ±fÄ±rla
            
            const msg = `*** SÆSVERMÆ BAÅLADI! ***<br>SizcÉ™ kim Gizli MÃ¼ÅŸtÉ™ridir? ÅÃ¼bhÉ™lÉ™ndiyiniz oyunÃ§unun <span class="text-red-700 font-bold">ADINI TAM ÅÆKÄ°LDÆ</span> Ã§ata yazÄ±n. HÉ™r kÉ™s yalnÄ±z bir dÉ™fÉ™ sÉ™s verÉ™ bilÉ™r.`;
            addSystemMessage(msg, true);
            broadcast({ type: 'game_msg', text: msg, html: true });
            
            updateGroupGameStatus('secret_customer', state);
        }

        // Gizli MÃ¼ÅŸtÉ™ri - NÉ™ticÉ™lÉ™ndir (YalnÄ±z Lider)
        function finalizeSecretCustomerGame(state) {
            // SÉ™slÉ™ri say
            const voteCounts = {};
            Object.values(state.votes).forEach(votedId => {
                voteCounts[votedId] = (voteCounts[votedId] || 0) + 1;
            });

            // Æn Ã§ox sÉ™s alan
            let mostVotedId = null;
            let maxVotes = 0;
            for (const id in voteCounts) {
                if (voteCounts[id] > maxVotes) {
                    maxVotes = voteCounts[id];
                    mostVotedId = id;
                }
            }

            const isCustomerFound = mostVotedId === state.secretCustomer;
            const customerName = state.players.find(p => p.peerId === state.secretCustomer)?.name || 'NamÉ™lum';
            const votedName = state.players.find(p => p.peerId === mostVotedId)?.name || 'HeÃ§ kim';
            
            let resultMsg = `<span class="text-2xl font-bold">*** OYUN BÄ°TDÄ°: NÆTÄ°CÆ ***</span><br>`;
            resultMsg += `HÉ™qiqi Gizli MÃ¼ÅŸtÉ™ri: <span class="text-red-700 font-bold">${customerName}</span><br>`;
            resultMsg += `Æn Ã§ox sÉ™s alan: <span class="text-red-700 font-bold">${votedName}</span> (${maxVotes} sÉ™s)<br><br>`;

            if (isCustomerFound) {
                resultMsg += `<span class="text-green-700 font-bold text-xl">AFÆRÄ°N! Personal Qalib gÉ™ldi!</span> Gizli MÃ¼ÅŸtÉ™ri uÄŸurla ifÅŸa edildi.`;
            } else {
                resultMsg += `<span class="text-blue-700 font-bold text-xl">GÄ°ZLÄ° MÃœÅTÆRÄ° Qalib gÉ™ldi!</span> O, ifÅŸa edilmÉ™di.`;
            }
            
            addSystemMessage(resultMsg, true);
            broadcast({ type: 'game_msg', text: resultMsg, html: true });

            // RaundlarÄ± artÄ±r (ÆgÉ™r tÉ™krar oynanÄ±lacaqsa)
            if (state.rounds < state.maxRounds && !isCustomerFound) {
                 state.status = 'roles_assigned'; // Yeni raunda hazÄ±rlaÅŸ
                 state.rounds++;
                 updateGroupGameStatus('secret_customer', state);
                 
                 const nextRoundMsg = `*** NÃ¶vbÉ™ti Raund ***<br>Gizli MÃ¼ÅŸtÉ™ri qaÃ§dÄ±! Yeni rollar paylanÄ±r. Lider, zÉ™hmÉ™t olmasa **BaÅŸla** dÃ¼ymÉ™sini basÄ±n.`;
                 addSystemMessage(nextRoundMsg, true);
                 broadcast({ type: 'game_msg', text: nextRoundMsg, html: true });
            } else {
                 // Oyunu tamamilÉ™ bitir
                 updateGroupGameStatus(null, null);
            }
        }
        
        // Gizli MÃ¼ÅŸtÉ™ri - TamamilÉ™ Bitir (YalnÄ±z Lider)
        window.endSecretCustomerGame = function() {
            if (!isGroupLeader) return;
            updateGroupGameStatus(null, null);
        }

        // KÉ™llÉ™-KÉ™llÉ™yÉ™ - TÉ™xmin MÉ™ntiqi (YalnÄ±z Lider)
        function initializeHangman() { /* ... É™vvÉ™lki kimi ... */
            const word = hangmanWords[Math.floor(Math.random() * hangmanWords.length)];
            return {
                word: word,
                guessedLetters: [],
                missesLeft: MAX_MISSES,
                guessedWord: null,
            };
        }
        function getHangmanDisplay(state) { /* ... É™vvÉ™lki kimi ... */
            let display = '';
            let isComplete = true;
            for (const char of state.word) {
                if (state.guessedLetters.includes(char)) {
                    display += char;
                } else {
                    display += '_';
                    isComplete = false;
                }
            }
            state.guessedWord = display;
            return { display, isComplete };
        }
        async function handleHangmanGuess(guess) {
            if (!gameData.game || gameData.game !== 'hangman' || !isGroupLeader) {
                 addSystemMessage("HazÄ±rda oyun aktiv deyil vÉ™ ya siz lider deyilsiniz.", false);
                 return;
            }
            
            const normalizedGuess = guess.toLowerCase().trim();
            
            const state = gameData.state;
            let resultMessage = '';

            if (normalizedGuess.length === 1) {
                if (state.guessedLetters.includes(normalizedGuess)) {
                    resultMessage = `HÉ™rf '${normalizedGuess}' artÄ±q tÉ™xmin edilib.`;
                } else {
                    state.guessedLetters.push(normalizedGuess);
                    if (state.word.includes(normalizedGuess)) {
                        resultMessage = `Æla! HÉ™rf '${normalizedGuess}' sÃ¶zdÉ™ var.`;
                    } else {
                        state.missesLeft--;
                        resultMessage = `YanlÄ±ÅŸdÄ±r. Qalan cÉ™za: ${state.missesLeft}`;
                    }
                }
            } else {
                if (normalizedGuess === state.word) {
                    resultMessage = `*** TÆBRÄ°KLÆR! *** SÃ¶zÃ¼ dÃ¼zgÃ¼n tapdÄ±: **${state.word}**`;
                    state.guessedWord = state.word;
                } else {
                    state.missesLeft--;
                    resultMessage = `YanlÄ±ÅŸ sÃ¶z. Qalan cÉ™za: ${state.missesLeft}`;
                }
            }

            const { display, isComplete } = getHangmanDisplay(state);

            if (isComplete || normalizedGuess === state.word || state.missesLeft <= 0) {
                 // QalibiyyÉ™t/MÉ™ÄŸlubiyyÉ™t
                if (normalizedGuess === state.word || isComplete) {
                     resultMessage = `*** OYUN BÄ°TDÄ°: QALÄ°BÄ°YYÆT! *** TapÄ±lan sÃ¶z: **${state.word}**`;
                } else {
                     resultMessage = `*** OYUN BÄ°TDÄ°: MÆÄLUBÄ°YYÆT! *** SÃ¶z: **${state.word}** idi.`;
                }

                await updateGroupGameStatus(null, null); // Oyunu bitir
                
            } else {
                // Oyuna davam
                resultMessage += `<br><br>SÃ¶z: <span class="hangman-display font-mono text-xl tracking-widest">${display.split('').join(' ')}</span><br>Qalan CÉ™za: ${state.missesLeft}<br>TÉ™xmin edilmiÅŸ hÉ™rflÉ™r: ${state.guessedLetters.sort().join(', ') || 'heÃ§ biri'}`;
                await updateGroupGameStatus('hangman', state);
            }
            
            addSystemMessage(resultMessage, true);
            broadcast({ type: 'game_msg', text: resultMessage, html: true });
            renderGameStatus();
        }

        // --- UI MÉ™ntiqi ---

        // Oyun SeÃ§im panelini gÃ¶stÉ™rmÉ™k/gizlÉ™tmÉ™k
        window.toggleGameSelector = function() {
            const selector = document.getElementById('game-selector');
            const isHidden = selector.classList.contains('hidden');
            
            if (isHidden) {
                selector.classList.remove('hidden');
                setTimeout(() => {
                    selector.classList.remove('game-selector-enter');
                    selector.classList.add('game-selector-enter-active');
                }, 10);
            } else {
                selector.classList.remove('game-selector-enter-active');
                selector.classList.add('game-selector-exit-active');
                setTimeout(() => {
                    selector.classList.add('hidden');
                    selector.classList.remove('game-selector-exit-active');
                    selector.classList.add('game-selector-enter');
                }, 200);
            }
        }

        // Oyun seÃ§ildikdÉ™ hÉ™m oyunu baÅŸlamaq, hÉ™m dÉ™ paneli gizlÉ™tmÉ™k
        window.selectGame = async function(gameName) {
            toggleGameSelector(); 

            if (!isGroupLeader) {
                alertModal("XÉ™bÉ™rdarlÄ±q", "Siz qrup rÉ™hbÉ™ri deyilsiniz. YalnÄ±z qrup rÉ™hbÉ™ri oyun baÅŸlada bilÉ™r.");
                return;
            }
            
            if (gameData.game) {
                 alertModal("XÉ™bÉ™rdarlÄ±q", `HazÄ±rda artÄ±q bir oyun (${gameData.game}) aktivdir.`);
                 return;
            }

            if (gameName === 'hangman') {
                const initialState = initializeHangman();
                const { display } = getHangmanDisplay(initialState);
                
                await updateGroupGameStatus('hangman', initialState);
                
                const startMsg = `
                    *** YENÄ° OYUN: KÉ™llÉ™-KÉ™llÉ™yÉ™ baÅŸladÄ±! ***<br>
                    SÃ¶z: <span class="hangman-display font-mono text-xl tracking-widest">${display.split('').join(' ')}</span><br>
                    Qalan CÉ™za: ${initialState.missesLeft} <br>
                    Ã‡ata hÉ™rf vÉ™ ya tam sÃ¶zÃ¼ yazÄ±n.
                `;
                
                addSystemMessage(startMsg, true);
                broadcast({ type: 'game_msg', text: startMsg, html: true });
                
            } else if (gameName === 'secret_customer') {
                const initialState = initializeSecretCustomer();
                if (!initialState) return;
                
                await updateGroupGameStatus('secret_customer', initialState);
                
                // RollarÄ± oyunÃ§ulara fÉ™rdi ÅŸÉ™kildÉ™ bildir
                initialState.players.forEach(p => {
                    const roleMsg = p.peerId === initialState.secretCustomer ? 
                        `*** SÄ°ZÄ°N ROLUNUZ: GÄ°ZLÄ° MÃœÅTÆRÄ° ***<br>SifariÅŸlÉ™rÉ™ qarÄ±ÅŸÄ±q cavab verin.` : 
                        `*** SÄ°ZÄ°N ROLUNUZ: ${p.role} ***<br>SifariÅŸlÉ™rÉ™ normal cavab verin vÉ™ MÃ¼ÅŸtÉ™rini tapÄ±n.`;
                    
                    if (p.peerId === myPeerId) {
                         alertModal("Rolunuz!", roleMsg);
                    } else if (connections[p.peerId]) {
                         connections[p.peerId].send({ type: 'game_msg', text: roleMsg, html: true });
                    }
                });

                const startMsg = `*** YENÄ° OYUN: Gizli MÃ¼ÅŸtÉ™ri baÅŸladÄ±! ***<br>Rollar paylandÄ±. ${initialState.players.length} nÉ™fÉ™r oynayÄ±r.`;
                addSystemMessage(startMsg, true);
                broadcast({ type: 'game_msg', text: startMsg, html: true });

                // Birinci sifariÅŸi ver
                advanceSecretCustomerGame();

            } else if (gameName === 'quiz') {
                 alertModal("MÉ™lumat", "Quiz oyunu hÉ™lÉ™ hazÄ±rlanma mÉ™rhÉ™lÉ™sindÉ™dir.");
            }
        }
        
        // Qrupdan AyrÄ±lmaq
        window.leaveGroup = function() {
            if (peer) {
                Object.values(connections).forEach(conn => conn.close());
                peer.destroy();
                peer = null;
            }
            
            // UI-Ä± sÄ±fÄ±rla
            document.getElementById('chat-panel').classList.add('hidden');
            document.getElementById('join-panel').classList.remove('hidden');
            
            // VÉ™ziyyÉ™tlÉ™ri sÄ±fÄ±rla
            myPeerId = null;
            connections = {};
            isGroupLeader = false;
            gameData = { game: null, state: null, myRole: null };
            activeGroupId = null;
            peerCount = 0;
            chatMessages = {}; // Mesaj yaddaÅŸÄ±nÄ± tÉ™mizlÉ™
            
            document.getElementById('messages').innerHTML = '';
            document.getElementById('group-id-input').value = '';
            addSystemMessage("Siz qrupdan ayrÄ±ldÄ±nÄ±z. Yeni qrupa qoÅŸulun.", true);
        }

        // --- KÃ¶mÉ™kÃ§i funksiyalar ---
        
        // PanellÉ™rin dÉ™yiÅŸdirilmÉ™si
        function showChatPanel() {
            document.getElementById('join-panel').classList.add('hidden');
            document.getElementById('chat-panel').classList.remove('hidden');
            renderGameStatus();
        }

        // Enter dÃ¼ymÉ™si ilÉ™ mesaj gÃ¶ndÉ™rmÉ™k
        window.handleKeyPress = function(e) { 
            if (e.key === 'Enter') sendMessage(); 
        }

        // ID-ni kopyalamaq
        window.copyId = function() {
            const idToCopy = document.getElementById('my-id-display').innerText;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(idToCopy).then(() => {
                    const msg = document.getElementById('copy-msg'); msg.style.opacity = '1';
                    setTimeout(() => msg.style.opacity = '0', 2000);
                }).catch(err => {
                    console.error('Kopyalama xÉ™tasÄ±:', err);
                });
            } else {
                 alertModal("XÉ™bÉ™rdarlÄ±q", "Kopyalama funksiyasÄ± brauzerinizdÉ™ dÉ™stÉ™klÉ™nmir.");
            }
        }
        
        // XÉ™bÉ™rdarlÄ±q/MÉ™lumat ModalÄ± (alert() yerinÉ™)
        function alertModal(title, message) {
            const existingModal = document.getElementById('custom-modal');
            if (existingModal) existingModal.remove();

            const modalHtml = `
                <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transform scale-100 transition-transform duration-300">
                        <h3 class="text-xl font-bold mb-4 text-red-800">${title}</h3>
                        <p class="text-gray-700 mb-6">${message}</p>
                        <button onclick="document.getElementById('custom-modal').remove()" 
                                class="w-full bg-red-800 hover:bg-red-700 text-white font-bold py-2 rounded-lg transition duration-200">
                            BaÅŸa DÃ¼ÅŸdÃ¼m
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // HTML-dÉ™n qaÃ§Ä±ÅŸ (escape) funksiyasÄ±
        function escapeHtml(text) { 
            if (typeof text !== 'string') return text;
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '\"': '&quot;',
                "\'": '&#039;'
            };
            return text.replace(/[&<>\"']/g, (m) => map[m]);
        }
    </script>
</body>
</html>